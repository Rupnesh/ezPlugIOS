(self.webpackChunkeZPlug=self.webpackChunkeZPlug||[]).push([[3712],{3712:(t,e,i)=>{"use strict";i.r(e),i.d(e,{ChargePageModule:()=>O});var n=i(8583),s=i(665),o=i(5298),a=i(7823),r=i(4762),c=i(6738),l=i(5466),h=i(2273),d=i(7716),g=i(4687),u=i(4471),p=i(7906),m=i(5970),b=i(6773);const S=["refresh"];function v(t,e){1&t&&d._UZ(0,"ion-back-button",32)}function I(t,e){1&t&&d._UZ(0,"ion-img",33)}function T(t,e){1&t&&d._UZ(0,"ion-img",34)}function Z(t,e){if(1&t){const t=d.EpF();d.TgZ(0,"ion-button",31),d.NdJ("click",function(){return d.CHM(t),d.oxw().boxSteps("unlock")}),d._uU(1,"UNLOCK "),d.qZA()}if(2&t){const t=d.oxw();d.Q6J("disabled",t.btnUnlock)}}function _(t,e){if(1&t&&(d.TgZ(0,"ion-button",35),d._UZ(1,"ion-spinner",36),d.qZA()),2&t){const t=d.oxw();d.Q6J("disabled",t.btnUnlock)}}let C=(()=>{class t{constructor(t,e,i,n,s,o,a,r,c,l){this.activatedRoute=t,this.router=e,this.callNumber=i,this.loaderService=n,this.dashboardService=s,this.modalController=o,this.alertService=a,this.signalRService=r,this.platform=c,this.renderer2=l,this.stationDetails=[],this.charge=!1,this.loaderMsg="",this.time="00:00:00",this.kwh=0,this.cost=0,this.btnPayment=!0,this.btnUnlock=!0,this.btnUnlockLoader=!1,this.btnPlugged=!0,this.transactionStatus=!1,this.stopRequest=!0,this.userID="",this.price=0,this.interval=1e3}localNotification(t){return(0,r.mG)(this,void 0,void 0,function*(){let e=c(c.now()).add(60*t,"minutes").format();yield h.s.schedule({notifications:[{title:"eZCharge Notification",body:"Estimated time reached",id:1,schedule:{at:c(e,c.defaultFormat).toDate()},attachments:[{id:"face",url:"http://placekitten.com/g/300/20",options:{}}],actionTypeId:"",extra:null}]})})}ngOnInit(){}ionViewWillEnter(){return(0,r.mG)(this,void 0,void 0,function*(){window.clearInterval(this.startInterval),this.time=0,this.startInterval=null;let t=parseInt(yield this.dashboardService.getItem(l.E.CHARGING_START_TIME)),e=c.now();t&&e&&(this.time=(e-t)/1e3,this.startInterval=setInterval(()=>{this.time=parseInt(this.time)+1},this.interval));let i=yield this.dashboardService.getObject(l.E.OTP_SESSION);yield this.signalRService.startConnection(i),this.price=yield this.dashboardService.getItem(l.E.PRICING_DETAILS),this.stopClicked=yield this.dashboardService.getItem(l.E.STOP_CLICKED),this.stationDetails=yield this.dashboardService.getObject(l.E.STATION_DETAILS_INFO),this.price||(this.price=this.stationDetails.pricingDetails),this.stationDetailsStorage=yield this.dashboardService.getObject(l.E.STATION_DETAILS),this.refreshChargedData(),this.chargingOptions=this.dashboardService.getObject(l.E.SELECTED_CHARGING_OPTIONS),this.estimatedData=this.dashboardService.getObject(l.E.ESTIMATED_DATA),null==this.chargingOptions&&(this.chargingOptions=yield this.dashboardService.getObject(l.E.SELECTED_CHARGING_OPTIONS)),this.transactionData()})}refreshChargedData(){return(0,r.mG)(this,void 0,void 0,function*(){if(console.log("called..."),this.refreshLoaded=!1,this.renderer2.addClass(this.refresh.nativeElement,"spin"),this.transactionID=yield this.dashboardService.getItem(l.E.TRANSACTION_ID),null!=this.transactionID)console.log("in if..."),this.dashboardService.getItem(l.E.TRANSACTION_ID).then(t=>{t&&(console.log("if data..."),this.transactionStatus=!0,this.charge=!0,this.dashboardService.energyConsumedDetails({transactionId:this.transactionID,stationName:this.stationDetailsStorage.stationName,connectorId:1}).subscribe(t=>{this.kwh=t.energyConsumed,this.cost=parseFloat(this.kwh)*parseFloat(this.price),this.time=t.timeSpentCharging,this.refreshLoaded=!0,this.renderer2.removeClass(this.refresh.nativeElement,"spin")}),this.dashboardService.getActiveTransactionForUser().subscribe(t=>{(null==t.chargingStatus||"NotCharging"==t.chargingStatus&&t.transactionId&&!t.isInvoiceAvailable)&&(this.stopClicked="false",this.btnUnlock=!0,this.btnPlugged=!0,console.log("get active..."))}),setTimeout(()=>{this.signalRService.notifyTransactionListener(this.stationDetailsStorage.stationName).subscribe(t=>{this.transactionData=t,this.kwh=t.energyConsumed,this.cost=parseFloat(this.kwh)*parseFloat(this.price)})},15e3))});else{console.log("in else...");let t=yield this.dashboardService.getItem(l.E.IS_CHARGING_ENABLED);this.dashboardService.getActiveTransactionForUser().subscribe(t=>{(null==t.chargingStatus||"NotCharging"==t.chargingStatus&&t.transactionId&&!t.isInvoiceAvailable)&&(this.stopClicked="true",this.btnUnlock=!1)},e=>{(null==e.chargingStatus||"NotCharging"==e.chargingStatus&&!e.transactionId)&&(this.kwh=0,this.cost=0,t?(this.stopClicked="false",this.btnUnlock=!0,this.startCharging()):(this.stopClicked="true",this.btnUnlock=!1))})}})}transactionData(){return(0,r.mG)(this,void 0,void 0,function*(){let t=yield this.dashboardService.getObject(l.E.OTP_SESSION);this.userID=t.user.userId})}callStation(t){this.callNumber.callNumber(t,!0).then(t=>console.log("Launched dialer!",t)).catch(t=>{this.alertService.presentToast(t)})}convertToTimeFormat(t){return c().startOf("day").seconds(t).format("HH:mm:ss")}startCharging(){return(0,r.mG)(this,void 0,void 0,function*(){window.clearInterval(this.startInterval),this.loaderMsg="Connecting to Station...",this.loaderService.showLoader(this.loaderMsg);let t=yield this.dashboardService.getObject(l.E.OTP_SESSION);this.userID=t.user.userId,this.dashboardService.startCharging({messageId:"RequestStartTransactionRequest",deviceId:this.stationDetailsStorage.stationName,userId:this.userID,stationId:this.stationDetailsStorage.stationId,connectorNumber:0}).subscribe(t=>{!1===t.hasError?1==t.response.status?(this.dashboardService.setItem("true",l.E.IS_CHARGING_ENABLED),this.time=0,this.dashboardService.setItem(c.now().toString(),l.E.CHARGING_START_TIME),this.startInterval=setInterval(()=>{this.time=this.time+1},this.interval),this.transactionStatus=!0,this.loaderService.hideLoader(),this.transactionID=t.response.transactionId,this.dashboardService.setItem(this.transactionID,l.E.TRANSACTION_ID),this.charge=!0,this.transactionID&&this.signalRService.notifyTransactionListener(this.stationDetailsStorage.stationName).subscribe(t=>{this.transactionData=t,this.kwh=t.energyConsumed,this.cost=parseFloat(this.kwh)*parseFloat(this.price),"TimeLimitReached"!==t.stoppedReason&&"EnergyLimitReached"!==t.stoppedReason||this.stopCharging()})):(this.loaderService.hideLoader(),this.alertService.presentAlertPopup("Power consumption not detected. Please check cable connection","app/station-details")):(this.btnUnlockLoader=!1,this.loaderService.hideLoader(),this.charge=!1,this.alertService.presentToast(t.errorDescription))},t=>{this.btnUnlockLoader=!1,this.loaderService.hideLoader(),this.charge=!1,this.alertService.presentToast(l.E.HTTP_RESPONSE_ERROR),this.startCharging()})})}stopCharging(){this.dashboardService.getItem(l.E.TRANSACTION_ID).then(t=>{let e={messageId:"RequestStopTransactionRequest",deviceId:this.stationDetailsStorage.stationName,userId:this.userID,transactionId:t};this.loaderMsg="Stopping Seesion & Calculating Bill",this.loaderService.showLoader(this.loaderMsg),this.dashboardService.stopCharging(e).subscribe(t=>{if(!1===t.hasError){this.dashboardService.setItem(this.time.toString(),l.E.PLUGGEDOUT_TIME),this.dashboardService.setItem("true",l.E.STOP_CLICKED),this.dashboardService.removeItemName(l.E.CHARGING_START_TIME),window.clearInterval(this.startInterval),this.loaderService.hideLoader(),this.transactionStatus=!1,this.stopRequest=!1,this.btnUnlock=!1,this.charge=!1;let t=Object.assign({tid:this.transactionID,kwh:this.kwh,time:this.time,cost:this.cost},this.chargingOptions);this.dashboardService.setObject(t,l.E.CHARGING_TRANSACTION_DATA),this.router.navigate(["app/bill"])}else this.btnUnlockLoader=!1,this.loaderService.hideLoader(),this.alertService.presentToast(t.errorDescription)},t=>{this.btnUnlockLoader=!1,this.loaderService.hideLoader(),this.alertService.presentToast(l.E.HTTP_RESPONSE_ERROR)})})}boxSteps(t){return(0,r.mG)(this,void 0,void 0,function*(){"unlock"===t&&(this.btnUnlockLoader=!0,this.dashboardService.unLockDevice({messageId:"DataTransferRequest",deviceId:this.stationDetailsStorage.stationName,userId:this.userID,operationId:0}).subscribe(t=>{!1===t.hasError?(this.btnPayment=!0,this.btnUnlock=!0,this.btnPlugged=!1,this.btnUnlockLoader=!1,this.dashboardService.removeItemName(l.E.IS_CHARGING_ENABLED),this.dashboardService.removeItemName(l.E.STOP_CLICKED)):(this.btnUnlockLoader=!1,this.alertService.presentToast(t.errorDescription))},t=>{this.btnUnlockLoader=!1,this.alertService.presentToast(l.E.HTTP_RESPONSE_ERROR),this.dashboardService.removeItemName(l.E.IS_CHARGING_ENABLED),this.dashboardService.removeItemName(l.E.STOP_CLICKED)})),"plugged"===t&&this.router.navigate(["app/dashboard"])})}returnNumber(t){return null===t?0:parseFloat(t).toFixed(2)}ionViewDidEnter(){this.subscription=this.platform.backButton.subscribeWithPriority(9999,()=>{this.router.navigate(["app/station-details"])})}}return t.\u0275fac=function(e){return new(e||t)(d.Y36(o.gz),d.Y36(o.F0),d.Y36(g.X),d.Y36(u.D),d.Y36(p.u),d.Y36(a.IN),d.Y36(m.c),d.Y36(b.M),d.Y36(a.t4),d.Y36(d.Qsj))},t.\u0275cmp=d.Xpm({type:t,selectors:[["app-charge"]],viewQuery:function(t,e){if(1&t&&d.Gf(S,5),2&t){let t;d.iGM(t=d.CRH())&&(e.refresh=t.first)}},decls:78,vars:17,consts:[["color","primary"],["slot","start"],["routerLink","/app/station-details",4,"ngIf"],[1,"ion-padding"],["size","7"],[2,"margin","0"],["size","5",1,"ion-text-right",3,"click"],[2,"text-decoration","underline","display","flex","float","right"],["name","call","color","primary",2,"margin-right","5px"],["size","12"],["name","pin","color","primary",2,"margin-right","5px"],[2,"min-height","0px"],["id","refresh",2,"position","absolute","top","0","right","0","padding","16px","z-index","99999",3,"click"],["refresh",""],["color","primary","name","refresh-outline",2,"font-size","20px"],["style","height: 200px;","src","../../assets/images/loaders/chargeFinal.svg",4,"ngIf"],["style","height: 200px;","src","../../assets/images/loaders/chargeFinalAni.svg",4,"ngIf"],[1,"ion-justify-content-center",2,"padding","15px 7px"],["size","4","size-sm","4","size-md","3","size-lg","3","size-xl","2",1,"ion-text-center","progress"],[1,"ion-justify-content-center"],["size","12","size-sm","12","size-md","9","size-lg","9","size-xl","6"],["expand","block","color","primary","type","submit","fill","solid",1,"submit-btn",3,"disabled","click"],["size","6","size-sm","6","size-md","3","size-lg","3","size-xl","2",1,"ion-text-center"],[1,"avatar-circle"],["name","lock-open-outline",1,"initials",3,"color"],["color","primary",2,"display","grid",3,"ngClass"],[2,"font-size","12px","padding-top","10px"],[2,"font-size","12px"],["shape","outline","expand","block",3,"disabled","click",4,"ngIf"],["shape","outline","expand","block",3,"disabled",4,"ngIf"],["name","git-branch-outline",1,"initials",3,"color"],["shape","outline","expand","block",3,"disabled","click"],["routerLink","/app/station-details"],["src","../../assets/images/loaders/chargeFinal.svg",2,"height","200px"],["src","../../assets/images/loaders/chargeFinalAni.svg",2,"height","200px"],["shape","outline","expand","block",3,"disabled"],["name","bubbles",2,"text-align","center","display","block","margin","0 auto"]],template:function(t,e){1&t&&(d.TgZ(0,"ion-header"),d.TgZ(1,"ion-toolbar",0),d.TgZ(2,"ion-buttons",1),d.YNc(3,v,1,0,"ion-back-button",2),d.qZA(),d.TgZ(4,"ion-title"),d._uU(5,"Charging"),d.qZA(),d.qZA(),d.qZA(),d.TgZ(6,"ion-content"),d.TgZ(7,"ion-card"),d.TgZ(8,"ion-row",3),d.TgZ(9,"ion-col",4),d.TgZ(10,"h4",5),d.TgZ(11,"ion-text",0),d._uU(12),d.qZA(),d.qZA(),d.qZA(),d.TgZ(13,"ion-col",6),d.NdJ("click",function(){return e.callStation(e.stationDetails.contact)}),d.TgZ(14,"span",7),d._UZ(15,"ion-icon",8),d.TgZ(16,"ion-text",0),d._uU(17),d.qZA(),d.qZA(),d.qZA(),d.TgZ(18,"ion-col",9),d._UZ(19,"ion-icon",10),d.TgZ(20,"ion-text",0),d._uU(21),d.qZA(),d.qZA(),d.qZA(),d._UZ(22,"ion-item-divider",11),d.TgZ(23,"ion-card-content"),d.TgZ(24,"ion-row"),d.TgZ(25,"div",12,13),d.NdJ("click",function(){return e.refreshChargedData()}),d._UZ(27,"ion-icon",14),d.qZA(),d.TgZ(28,"ion-col",9),d.YNc(29,I,1,0,"ion-img",15),d.YNc(30,T,1,0,"ion-img",16),d.qZA(),d.qZA(),d.TgZ(31,"ion-row",17),d.TgZ(32,"ion-col",18),d.TgZ(33,"p"),d._uU(34,"Time"),d.qZA(),d.TgZ(35,"p"),d._uU(36),d.qZA(),d.TgZ(37,"span"),d._uU(38,"hour"),d.qZA(),d.qZA(),d.TgZ(39,"ion-col",18),d.TgZ(40,"p"),d._uU(41,"kWh"),d.qZA(),d.TgZ(42,"p"),d._uU(43),d.qZA(),d.TgZ(44,"span"),d._uU(45,"units"),d.qZA(),d.qZA(),d.TgZ(46,"ion-col",18),d.TgZ(47,"p"),d._uU(48,"Cost"),d.qZA(),d.TgZ(49,"p"),d._uU(50),d.qZA(),d.TgZ(51,"span"),d._uU(52,"INR"),d.qZA(),d.qZA(),d.qZA(),d.TgZ(53,"ion-row",19),d.TgZ(54,"ion-col",20),d.TgZ(55,"ion-button",21),d.NdJ("click",function(){return e.stopCharging()}),d._uU(56,"STOP"),d.qZA(),d.qZA(),d.qZA(),d.TgZ(57,"ion-row",19),d.TgZ(58,"ion-col",22),d.TgZ(59,"div",23),d._UZ(60,"ion-icon",24),d.qZA(),d.TgZ(61,"ion-text",25),d.TgZ(62,"ion-label",26),d._uU(63,"Step 1"),d.qZA(),d.TgZ(64,"ion-label",27),d._uU(65,"Unlock box"),d.qZA(),d.qZA(),d.YNc(66,Z,2,1,"ion-button",28),d.YNc(67,_,2,1,"ion-button",29),d.qZA(),d.TgZ(68,"ion-col",22),d.TgZ(69,"div",23),d._UZ(70,"ion-icon",30),d.qZA(),d.TgZ(71,"ion-text",25),d.TgZ(72,"ion-label",26),d._uU(73,"Step 2"),d.qZA(),d.TgZ(74,"ion-label",27),d._uU(75,"UnPlug Cable"),d.qZA(),d.qZA(),d.TgZ(76,"ion-button",31),d.NdJ("click",function(){return e.boxSteps("plugged")}),d._uU(77,"DONE "),d.qZA(),d.qZA(),d.qZA(),d.qZA(),d.qZA(),d.qZA()),2&t&&(d.xp6(3),d.Q6J("ngIf",!e.transactionStatus),d.xp6(9),d.Oqu(e.stationDetails.siteName),d.xp6(5),d.Oqu(e.stationDetails.contact),d.xp6(4),d.Oqu(e.stationDetails.address),d.xp6(8),d.Q6J("ngIf",!e.charge),d.xp6(1),d.Q6J("ngIf",e.charge),d.xp6(6),d.Oqu(e.convertToTimeFormat(e.time)),d.xp6(7),d.Oqu(e.returnNumber(e.kwh)),d.xp6(7),d.Oqu(e.returnNumber(e.cost)),d.xp6(5),d.Q6J("disabled",e.stopClicked),d.xp6(5),d.Q6J("color",e.btnUnlock?"light":"primary"),d.xp6(1),d.Q6J("ngClass",e.btnUnlock?"text-icon-muted":""),d.xp6(5),d.Q6J("ngIf",!e.btnUnlockLoader),d.xp6(1),d.Q6J("ngIf",e.btnUnlockLoader),d.xp6(3),d.Q6J("color",e.btnPlugged?"light":"primary"),d.xp6(1),d.Q6J("ngClass",e.btnPlugged?"text-icon-muted":""),d.xp6(5),d.Q6J("disabled",e.btnPlugged))},directives:[a.Gu,a.sr,a.Sm,n.O5,a.wd,a.W2,a.PM,a.Nd,a.wI,a.yW,a.gu,a.rH,a.FN,a.YG,n.mk,a.Q$,a.oU,a.cs,a.YI,o.rH,a.Xz,a.PQ],styles:["[_nghost-%COMP%]{--page-page-color:var(--ion-color-page-content)}.text-icon-muted[_ngcontent-%COMP%]{color:#21658180!important}.text-muted[_ngcontent-%COMP%]{color:#00000080!important;font-size:14px}.text-muted-icon[_ngcontent-%COMP%]{--color:rgba(#000,0.5)!important}.avatar-circle[_ngcontent-%COMP%]{width:36px;height:36px;text-align:center;border-radius:50%;-webkit-border-radius:50%;-moz-border-radius:50%;display:table;margin:0 auto}.initials[_ngcontent-%COMP%]{color:#fff;display:table-cell;vertical-align:middle}ion-content[_ngcontent-%COMP%]{--ion-background-color:var(--page-page-color)}ion-card[_ngcontent-%COMP%], ion-item-divider[_ngcontent-%COMP%]{background-color:#fff!important}.grid[_ngcontent-%COMP%]{position:relative;margin:40px auto}.grid[_ngcontent-%COMP%], .grid-item[_ngcontent-%COMP%]{width:100%;height:100px}.grid-item[_ngcontent-%COMP%]{justify-content:center;align-items:center;flex-direction:row;display:flex}#loading3[_ngcontent-%COMP%]{position:absolute;width:60px;height:30px}#loading3[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:6px;height:40px;display:inline-block;background-color:#4caf50;animation:strechdelay 1.2s ease-in-out infinite}#loading3[_ngcontent-%COMP%]   .line2[_ngcontent-%COMP%]{-webkit-animation-delay:-1.1s}#loading3[_ngcontent-%COMP%]   .line3[_ngcontent-%COMP%]{-webkit-animation-delay:-1s}#loading3[_ngcontent-%COMP%]   .line4[_ngcontent-%COMP%]{-webkit-animation-delay:-.9s}#loading3[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{margin-right:4px}#loading4[_ngcontent-%COMP%]{position:absolute;width:60px;height:30px}#loading4[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:6px;height:30px;display:inline-block;background-color:#4caf50}#loading4[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{margin-right:4px}.progress[_ngcontent-%COMP%]{background-color:#216581}.progress[_ngcontent-%COMP%]   p[_ngcontent-%COMP%], .progress[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:#fff}p[_ngcontent-%COMP%]{color:#191919}.spin[_ngcontent-%COMP%]{animation-name:spin;animation-duration:1s;animation-iteration-count:1;animation-timing-function:linear}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}"]}),t})();var f=i(1188);const A=[{path:"",component:C}];let O=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=d.oAB({type:t}),t.\u0275inj=d.cJS({providers:[p.u,f.V],imports:[[n.ez,s.u5,a.Pc,o.Bz.forChild(A)]]}),t})()}}]);